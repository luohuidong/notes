# JS-为什么 0.1 + 0.2 不等于 0.3

## 了解 IEEE 754

JS 的 `Number` 类型遵循的是 IEEE 754 标准，使用的是 64 位固定长度来表示。

IEEE 754 浮点数由三个域组成，分别为 sign bit (符号位)、exponent bias (指数偏移值) 和 fraction (分数值)。64 位中，sign bit 占 1 位，exponent bias 占 11 位，fraction 占 52 位。通过公式表示浮点数的值 **value = sign x exponent x fraction**。当一个数为正数，sign bit 为 0，当为负数时，sign bit 为 1.

以 0.1 转换为 IEEE 754 标准表示为例解释一下如何求 exponent bias 和 fraction。转换过程主要经历 3 个过程：

1. 将 0.1 转换为二进制表示
2. 将转换后的二进制通过科学计数法表示
3. 将通过科学计数法表示的二进制转换为 IEEE 754 标准表示

### 将 0.1 转换为二进制表示

回顾一下一个数的小数部分如何转换为二进制。一个数的小数部分，乘以 2，然后取整数部分的结果，再用计算后的小数部分重复计算，直到小数部分为 0 。

因此 0.1 转换为二进制表示的过程如下：

| 小数 | x2 的结果 | 整数部分 |
| :--: | :-------: | :------: |
| 0.1  |    0.2    |    0     |
| 0.2  |    0.4    |    0     |
| 0.4  |    0.8    |    0     |
| 0.8  |    1.6    |    1     |
| 0.6  |    1.2    |    1     |
| 0.2  |    0.4    |    0     |
| 0.4  |    0.8    |    0     |
| 0.8  |    1.6    |    1     |
| 0.6  |    1.2    |    1     |
| ...  |    ...    |   ...    |

得到 0.1 的二进制表示为 0.00011...(无限重复 0011)

### 通过科学计数法表示

0.00011...(无限重复 0011) 通过科学计数法表示则是 1.10011001...(无线重复 1001)\*2

### 转换为 IEEE 754 标准表示

当经过科学计数法表示之后，就可以求得 exponent bias 和 fraction 了。

exponent bias (指数偏移值) **等于** 双精度浮点数**固定偏移值** (2-1) 加上指数实际值(即 2 中的 -4) 的 **11 位二进制表示**。为什么是 11 位？因为 exponent bias 在 64 位中占 11 位。

因此 0.1 的 exponent bias **等于** 1023 + (-4) = 1019 的 11 位二进制表示，即 011 1111 1011。

再来获取 0.1 的 fraction，fraction 就是 1.10011001...(无线重复 1001) 中的小数位，由于 fraction 占 52 位所以抽取 52 位小数，1001...(中间有 11 个 1001)...1010 **(请注意最后四位，是 1010 而不是 1001，因为四舍五入有进位，这个进位就是造成 0.1 + 0.2 不等于 0.3 的原因)**。
\*\*
到此，终于可以将 0.1 转换为 IEEE 754 表示了。

```bash
    0       011 1111 1011   1001...( 11 x 1001)...1010
(sign bit) (exponent bias)      (fraction)
```

此时如果将这个数转换为十进制，可以发现值已经变为 0.100000000000000005551115123126 而不是 0.1 了。

## 回归到 0.1 + 0.2 != 0.3 这个问题

通过上面的过程，我们知道了 JS 因为遵循了 IEEE 754 产生浮点误差的原因。因此不仅 0.1 会产生误差，0.2 及 0.3 也是如此，因此最后造成了 0.1 + 0.2 不等于 0.3 的结果。

## 参考资料

- [YouTube - Decimal to IEEE 754 Floating Point Representation](https://www.youtube.com/watch?v=8afbTaA-gOQ)
- [GitHub camsong - JavaScript 浮点数陷阱及解法](https://github.com/camsong/blog/issues/9)
- [维基百科 - 符号位相关信息](https://zh.wikipedia.org/wiki/%E6%9C%89%E7%AC%A6%E8%99%9F%E6%95%B8%E8%99%95%E7%90%86#%E5%8E%9F%E7%A0%81)
- [维基百科 - IEEE 754](https://zh.wikipedia.org/wiki/IEEE_754)

## 工具

- [十进制转 IEEE 754 双精度浮点数值](http://www.binaryconvert.com/convert_double.html)
