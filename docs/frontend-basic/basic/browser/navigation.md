# 从输入 URL 到页面展示，中间发生了什么 —— 导航阶段

## 导航阶段 (Navigation)

在浏览器中我们输入 url 打开一个网站，这中间是有一个导航的过程的，这就跟现实中我们使用导航去某个目的地类似。

在导航阶段，会经历以下过程：

1. 用户输入
2. URL 请求
3. 准备渲染进程
4. 提交文档

这些过程会涉及到浏览器中的浏览器进程、网络进程、渲染进程：

1. **浏览器进程** 接收到用户输入的 URL 请求，**浏览器进程** 将该 URL 转发给 **网络进程**。
2. **网络进程** 发起真正的 URL 请求。
3. **网络进程** 接收到了响应头数据后解析响应头数据，并将数据转发给 **浏览器进程**。
4. **浏览器进程** 接收到 **网络进程** 的响应头数据之后，发送“提交导航”消息到 **渲染进程**。
5. **渲染进程** 接收到“提交导航”的消息之后，便开始准备接收 HTML 数据，接收数据的方式是直接和 **网络进程** 建立数据管道。
6. **渲染进程** 会向 **浏览器进程** “确认提交”，这是告诉 **浏览器进程**：“已经准备好接收和解析页面数据了”。
7. **浏览器进程** 接收到 **渲染进程** “确认提交”的消息之后，便开始移除之前旧的文档，然后更新 **浏览器进程** 中的页面状态。

下面会分析导航阶段：

### 用户输入

这个阶段是根据用户在地址栏中输入的内容合成新的 URL。

用户在浏览器地址栏输入的内容有两种，一种是搜索内容，另外一种是 URL。如果是搜索内容，地址栏会使用浏览器默认的搜索引擎，来合成新的带搜索关键字的 URL。如果判断输入内容符合 URL 规则，那么地址栏会根据规则，将用户输入的 URL 合成完整的 URL，例如我们输入 google.com，浏览器会自动合成为 https://www.google.com/ 。

当用户按下回车键之后，如果当前 tab 原来已经有页面了，那会去触发原来页面的 beforeunload 事件。如果页面有添加 beforeunload 事件的处理函数，那么就会弹出一个对话框，询问用户是否离开用户，这样做的目的主要是用于防止页面上未保存数据的丢失。如果用户确认，那么将导航到新的页面，如果取消，则页面不再做导航操作。

下面为 beforeunload 使用的例子，在页面卸载的时候就会弹出确认对话框。

```html
<h1>Hello world</h1>
<script>
  window.addEventListener("beforeunload", (event) => {
    event.preventDefault();
    event.returnValue = "";
  });
</script>
```

### 网络请求与响应

当获取到新的 URL 之后，便到了请求页面资源的过程。浏览器进程会通过 IPC 把 URL 请求发送至网络进程，网络进程接收到 URL 请求后，会在这里发起真正的 URL 请求流程。

#### 请求发送

1. 网络进程会查找本地缓存是否缓存了该资源。如果有缓存资源，那么直接返回资源给浏览器进程。如果没有找到缓存，则直接进入网络请求流程。
1. DNS 解析获取请求域名的服务器 IP 地址。
1. 利用 IP 地址和服务器建立 TCP 连接。
1. 如果请求协议是 HTTPS，那么还需要建立 TLS 连接。
1. 浏览器端构建请求行、请求头等信息，然后向服务器发送构建的请求信息。
1. 服务器接受到请求信息后，会根据请求信息生成响应数据，并发给网络进程。

#### 响应解析

当浏览器接收到响应头后，网络进程开始解析响应头，响应头中包含了足够的信息来决定后续需要做什么。

有两种情况在请求完之后，并不会有新的文档会被渲染：

1. 状态码是 204 或者 205，由于服务器后面没有返回内容，因此当前文档会继续保持活动状态。
2. 响应头中提示浏览器应将响应视作下载而不是导航。

如果响应提示需要重定向，网络进程会从响应头的 Location 字段中读取重定向的地址，然后再发起新的 HTTP 或者 HTTPS 请求。如果 Content-Type 提示返回的是一个 HTML，那么浏览器会继续进行导航流程。

### 准备渲染进程

在默认情况下，Chrome 会为每个页面分配一个渲染进程。也就是说，每打开一个新页面，就会配套创建一个新的渲染进程。例如原本页面显示的是百度的页面，当用户输入 Google 的地址的时候，是会给它创建一个新的渲染进程的，并不会复用百度页面的渲染进程，这个打开 Chrome 的 Task Manager 就可以清晰看到前后两个页面的 Process ID 是不一样的。

但是如果两个页面是同一站点的话，是可能存在复用渲染进程的情况的。两个页面的 URL 符合 **根域名** 相同、**协议** 相同，这两个页面就属于同一站点。当 A 页面打开 B 页面，并且 A 和 B 属于同一站点，那么 B 页面就会复用 A 页面的渲染进程。例如 https://www.baidu.com/ (百度搜索) 这个页面打开 https://map.baidu.com/ (百度地图) 这个页面，从 Chrome 的 Task Manager 中可以看出，百度地图页面复用了百度搜索页面的渲染进程。

当渲染进程准备好之后，还不能立即进入文档解析状态，因为此时文档数据还在网络进程中，并没有提交给渲染进程，所以下一步就进入了提交文档阶段。

### 提交文档

所谓的提交文档，就是指浏览器进程将网络进程接收到的 HTML 数据提交给渲染进程，具体流程：

1. 浏览器进程接收到网络进程的响应头数据之后，便向渲染进程发起“提交文档”的消息。
2. 渲染进程接收到“提交文档”的消息后，会和网络进程建立传输数据的“管道”。
3. 当渲染进程利用网络进程传输的文档数据数据创建完新的文档后，渲染进程会返回“确认提交”的消息给浏览器进程。
4. 浏览器进程在接收到“确认提交”的消息后，会更新浏览器界面状态，包括安全状态、地址栏 URL、前进后退的历史状态，并更新 Web 页面。

**到这里，一个完整的导航流程就走完了，之后就进入渲染阶段。**

## 渲染阶段

当导航完成之后，浏览器将进入渲染阶段。在渲染阶段会包含下面的步骤：

1. 继续读取来自服务器的剩余响应数据
2. 对响应数据进行解析
3. 渲染文档以便用户可以看见
4. 执行文档中附带的所有脚本
5. 加载所有子资源

## 参考资料

- [浏览器工作原理与实践 - 04 | 导航流程：从输入 URL 到页面展示，这中间发生了什么？](https://time.geekbang.org/column/article/117637)
- [Life of a Navigation](https://chromium.googlesource.com/chromium/src/+/master/docs/navigation.md)
- [Navigation Concepts](https://chromium.googlesource.com/chromium/src/+/master/docs/navigation_concepts.md)
- [MDN - Window: beforeunload event](https://developer.mozilla.org/en-US/docs/Web/API/Window/beforeunload_event)
